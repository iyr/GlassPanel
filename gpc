#!/bin/bash

#Vanilla Console Resolution is 80 Columns by 22 Rows (mostly).

#Detect Initial Setup
USER=$(whoami)
PACKAGE_MANAGER="YUM"

MOTD="/tmp/.tmpmotd_$USER"

#Remove temporary motd, if one already exists.
if [ -f "$MOTD" ]
	then
	rm $MOTD
fi

if [ $USER = "root" ]
	then
		SETTINGS="/root/.gpc_settings_root"
	else
		SETTINGS="/home/$USER/.gpc_settings_$USER"
fi

if [ -f "$SETTINGS" ]
	then
		echo "Configuration file detected for $USER!"
		echo "Reading settings..."
		
	else
		echo "No configuration file found!"
		echo "Detecting system..."
		echo "Appending $USER's bash profile..."
		
		if [ $USER = "root" ]
			then
				echo "cat $MOTD" >> /root/.bash_profile
			else
				echo "cat $MOTD" >> /home/$USER/.bash_profile
		fi

		echo "Generating settings file for $USER..."		
		#Generate Tweakable Settings file
		echo "USER=$USER" >> $SETTINGS
		echo "\n" >> $SETTINGS
		echo "#Insert a custom static header to the Glass Panel, if desired:" >> $SETTINGS
		echo "HEADER=" >> $SETTINGS
		echo "\n" >> $SETTINGS
		echo "#Append a custom static footer to the Glass Panel, if desired:" >> $SETTINGS
		echo "\n" >> $SETTINGS
		echo "#Adjust settings for color coding; below moderate is green, below critical is yellow and above is red" >> $SETTINGS
		echo "#Memory Settings:" >> $SETTINGS
		echo "MODERATE_MEM=60" >> $SETTINGS
		echo "CRITICAL_MEM=80" >> $SETTINGS
		echo "#CPU Settings:" >> $SETTINGS
		echo "MODERATE_CPU=60" >> $SETTINGS
		echo "CRITICAL_CPU=80" >> $SETTINGS
		echo "\n" >> $SETTINGS
		echo "#Allows you to append the status of selected services to the motd (none enabled by default)" >> $SETTINGS
		echo "#Usage: SERVICE \"ServiceName\" \"ServiceAlias\" (no spaces in alias)" >> $SETTINGS
		echo "#Example: SERVICE NetworkManager Networking" >> $SETTINGS
		echo "\n" >> $SETTINGS
		echo "#Environment Settings, do not edit." >> $SETTINGS
fi


#Print the status of a service:
NM_STATUS=$(service NetworkManager status | awk 'NR == 3 {print $2}')
if [ $NM_STATUS = "active" ]
	then
	echo -e "[ \e[0;32mNetworking\e[0m ]" >> $MOTD
	else
	echo -e "[ \e[0;31mNetworking\e[0m ]" >> $MOTD
fi

#Detect Internet availability:
GOOGLE_STATUS=$(ping -c4 google.com | awk 'NR == 8 {print $6}' | cut -c1)
if [ $GOOGLE_STATUS -eq 0 ]
	then
	INT_STATUS="true"
	echo -e "[ \e[0;32mINT\e[0m ]" >> $MOTD
	elif [ $GOOGLE_STATUS -gt 0  ]
		then
		INT_STATUS="false"
		echo -e "[ \e[1;33mINT\e[0m ]" >> $MOTD
	else
	INT_STATUS="false"
	echo -e "[ \e[0;31mINT\e[0m ]" >> $MOTD
fi

#Calculates the system memory usage as a rounded integer percentage and prints to a log
CUR_MEM=$(free | awk 'NR == 3 {print $3} NR == 2 {print $2}' | paste -sd" " | awk 'NR ==1 {print $2/$1*100}' | awk '{printf("%d\n",$1 + 0.5)}')
if [ $CUR_MEM -lt 60 ]
	then
	echo -e "[ \e[0;32mRAM\e[0m ][ \e[0;32m%$CUR_MEM\e[0m memory in use ]" >> $MOTD
	
	elif [ $CUR_MEM -ge 60 -a $CUR_MEM -lt 80 ]
	then
	echo -e "[ \e[1;33mRAM\e[0m ][ \e[1;33m%$CUR_MEM\e[0m memory in use ]" >> $MOTD
	
	else
	echo -e "[ \e[0;31mRAM\e[0m ][ \e[0;31m%$CUR_MEM\e[0m memory in use ]" >> $MOTD
fi

CUR_CPU=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print $1}' | awk '{printf("%d\n",$1 + 0.5)}')
#Possibly the least elegant way to calculate average cpu usage and normalize to cpu core count:
AVE_CPU=$(echo "$(echo "($(uptime | awk '{print $10}') / $(cat /proc/cpuinfo | grep -c "processor")) * 100" | bc -l) / 1 " | bc)
if [ $CUR_CPU -lt 60 ]
        then
        echo -e "[ \e[0;32mCPU\e[0m ][ \e[0;32m%$CUR_CPU\e[0m CPU in use ]" >> $MOTD

        elif [ $CUR_CPU -ge 60 -a $CUR_CPU -lt 80 ]
        then
	echo -e "[ \e[1;33mCPU\e[0m ][ \e[1;33m%$CUR_CPU\e[0m CPU in use ]" >> $MOTD

        else
        echo -e "[ \e[0;31mCPU\e[0m ][ \e[0;31m%$CUR_CPU\e[0m CPU in use ]" >> $MOTD
fi
echo $AVE_CPU

#Determine how many (if any) updates are available.
if [ $INT_STATUS = "false" ]
	then
	echo -e "[ \e[0;31m$PACKAGE_MANAGER\e[0m ][ No connection to internet ]" >> $MOTD
	else
		NUM_UPDATES=$(yum check-update | grep -c "updates")
		if [ $NUM_UPDATES -ne 0 ]
			then
			echo -e "[ \e[1;33m$PACKAGE_MANAGER\e[0m ][ $NUM_UPDATES updates available ]" >> $MOTD
			else
			echo -e "[ \e[0;32m$PACKAGE_MANAGER\e[0m ][ $NUM_UPDATES updates available, System is up to date ]" >> $MOTD
		fi
fi

#Determine status of SELinux and display how many (if any) alerts there are:
#enforcing 	= green
#permissive 	= yellow
#disabled 	= red
SEL_STATUS=$(sestatus | awk 'NR == 5 {print $3}')
SEL_ALERTS=$(sealert -l* | grep -c "denied") 
echo $SEL_STATUS
if [ $SEL_STATUS = "enforcing" ]
	then
	echo -e "[ \e[0;32mSEL\e[0m ][ $SEL_ALERTS alerts ]" >> $MOTD
	elif [ $SEL_STATUS = "permissive" ]
		then
		echo -e "[ \e[1;33mSEL\e[0m ][ $SEL_ALERTS alerts ]" >> $MOTD
	else
	echo -e "[ \e[0;31mSEL\e[0m ][ $SEL_ALERTS alerts ]" >> $MOTD
fi

cat $MOTD
